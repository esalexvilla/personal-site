---
import Modal from "./Modal.astro";

interface TimelineItem {
  date: string;
  title: string;
  description: string[];
}

interface Props {
  items: TimelineItem[];
}

const { items } = Astro.props;
---

<div class="timeline">
  {items.map((item, index) => {
    const modalId = `timeline-modal-${index}`;

    return (
      <div class="timeline-item">
        <div class="timeline-marker"></div>
        <button class="timeline-content" type="button" data-modal-open={modalId} aria-haspopup="dialog">
          <div class="timeline-date">{item.date}</div>
          <div class="timeline-title">{item.title}</div>
          <div class="timeline-summary">{item.description[0]}</div>
          <div class="timeline-hint">Click to view details</div>
        </button>
        <Modal id={modalId} title={item.title}>
          <div class="timeline-modal-date">{item.date}</div>
          <div class="timeline-modal-description">
            {item.description.map((desc) => (
              <p>{desc}</p>
            ))}
          </div>
        </Modal>
      </div>
    );
  })}
</div>

<script is:inline>
  const openButtons = document.querySelectorAll('[data-modal-open]');
  const closeTargets = document.querySelectorAll('[data-modal-close]');

  const openModal = (id) => {
    const modal = document.getElementById(id);
    if (!modal) return;
    modal.hidden = false;
    const closeButton = modal.querySelector('[data-modal-close]');
    closeButton?.focus();
  };

  const closeModal = (modal) => {
    if (!modal) return;
    modal.hidden = true;
  };

  openButtons.forEach((button) => {
    button.addEventListener('click', () => {
      const id = button.getAttribute('data-modal-open');
      if (id) openModal(id);
    });
  });

  closeTargets.forEach((target) => {
    target.addEventListener('click', () => {
      const modal = target.closest('.modal');
      closeModal(modal);
    });
  });

  document.addEventListener('keydown', (event) => {
    if (event.key !== 'Escape') return;
    document.querySelectorAll('.modal:not([hidden])').forEach((modal) => closeModal(modal));
  });
</script>

<style>
	.timeline {
		display: flex;
		flex-direction: column;
		position: relative;
	}

	.timeline-item {
		display: flex;
		gap: 1rem;
		position: relative;
		padding-bottom: 1.5rem;
	}

	.timeline-item:last-child {
		padding-bottom: 0;
	}

	.timeline-item:not(:last-child)::after {
		content: '';
		position: absolute;
		left: calc(0.5rem - 1px);
		top: calc(0.5rem + 0.25rem);
		height: 100%;
		width: 2px;
		background: var(--timeline-line);
	}

	.timeline-marker {
		width: 1rem;
		height: 1rem;
		background: var(--timeline-marker-bg);
		border: 2px solid var(--timeline-marker-border);
		position: relative;
		flex-shrink: 0;
		margin-top: 0.25rem;
		z-index: 1;
	}

	.timeline-content {
		border: 2px solid var(--timeline-content-border);
		padding: 0.75rem;
		flex-grow: 1;
		background-color: var(--window-content-bg);
		text-align: left;
		cursor: pointer;
		width: 100%;
		font: inherit;
		appearance: none;
		color: var(--text-color);
	}

	.timeline-date {
		font-size: 0.75rem;
		color: var(--timeline-date-color);
		margin-bottom: 0.25rem;
		font-weight: bold;
	}

	.timeline-title {
		font-weight: bold;
		margin-bottom: 0.5rem;
	}

	.timeline-content:hover {
		background-color: var(--button-hover);
	}

	.timeline-content:focus-visible {
		outline: 2px solid var(--timeline-marker-border);
		outline-offset: 2px;
	}

	.timeline-hint {
		font-size: 0.8rem;
		color: var(--timeline-date-color);
	}

	.timeline-summary {
		font-size: 0.9rem;
		line-height: 1.4;
		margin-bottom: 0.4rem;
	}

	.timeline-modal-date {
		font-size: 0.85rem;
		color: var(--timeline-date-color);
		font-weight: bold;
	}

	.timeline-modal-description {
		display: grid;
		gap: 0.75rem;
	}
</style>
